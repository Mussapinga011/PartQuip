-- ============================================
-- IMPORTAÇÃO DE HISTÓRICO DE VENDAS (PARTE 1)
-- ============================================

-- INSTRUÇÕES: 
-- 1. Execute este script no SQL Editor do Supabase.
-- 2. Ele assume que você já tem as peças cadastradas com os códigos correspondentes.
-- 3. O script busca o primeiro usuário disponível para atribuir a venda.

DO $$ 
DECLARE 
  v_user_id UUID;
BEGIN
  -- Obter o ID do primeiro usuário autenticado
  SELECT id INTO v_user_id FROM auth.users LIMIT 1;
  
  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'Nenhum usuário encontrado em auth.users. Certifique-se de que você está logado.';
  END IF;

  -- Criar tabela temporária para dados brutos
  CREATE TEMP TABLE raw_data_import (
    dt DATE,
    code TEXT,
    qty INT,
    price DECIMAL
  );

  -- JANEIRO A JUNHO 2025 (E ALGUNS 2024)
  INSERT INTO raw_data_import (dt, code, qty, price) VALUES
  ('2025-01-21', 'AR1549', 2, 6),
  ('2025-01-18', 'AR22', 5, 5),
  ('2025-01-04', 'AR32', 1, 15),
  ('2025-01-18', 'AR32', 2, 15),
  ('2025-01-28', 'AR32', 3, 6),
  ('2025-01-14', 'AR33', 6, 6),
  ('2025-01-14', 'AR33', 3, 3),
  ('2025-01-25', 'AR33', 6, 6),
  ('2025-01-16', 'AR5065', 1, 25),
  ('2025-01-12', 'AR5092', 8, 10),
  ('2025-01-16', 'AR5149', 2, 6),
  ('2025-01-16', 'AR5149', 2, 6),
  ('2025-01-22', 'AR5273', 1, 25),
  ('2025-01-25', 'AR5299', 2, 30),
  ('2025-01-02', 'AR5379', 1, 24),
  ('2025-01-12', 'AR5413', 2, 20),
  ('2025-01-28', 'AR5413', 2, 18),
  ('2025-01-22', 'AR5543', 2, 15),
  ('2025-01-18', 'AR5647', 1, 10),
  ('2025-01-29', 'AR5647', 2, 30),
  ('2025-01-08', 'AR5776', 2, 13),
  ('2025-01-23', 'AR5776', 2, 28),
  ('2025-01-08', 'AR5940', 2, 8),
  ('2025-01-08', 'AR5946', 1, 12),
  ('2025-01-23', 'AR5946', 1, 24),
  ('2025-01-12', 'AR5947', 4, 12),
  ('2025-01-16', 'AR5947', 2, 6),
  ('2025-01-29', 'AR6036', 1, 6),
  ('2025-01-12', 'AR6062', 1, 10),
  ('2025-01-18', 'AR6066', 2, 6),
  ('2025-01-15', 'AR6199', 2, 30),
  ('2025-01-12', 'AR6417', 2, 24),
  ('2025-01-09', 'AR7527', 2, 25),
  ('2025-01-18', 'AR7527', 4, 50),
  ('2025-01-09', 'AR7571', 1, 4),
  ('2025-01-04', 'AR7576', 2, 60),
  ('2025-01-07', 'AR7577', 2, 18),
  ('2025-01-07', 'AR7578', 2, 24),
  ('2025-01-25', 'AR7590', 2, 18),
  ('2025-01-04', 'AR7591', 2, 28),
  ('2025-01-14', 'AR7616', 4, 12),
  ('2025-01-28', 'AR7617', 2, 20),
  ('2025-01-25', 'AR7649', 2, 24),
  ('2025-01-16', 'AR8205', 2, 30),
  ('2025-01-16', 'AR8369', 2, 8),
  ('2025-01-07', 'AR8571', 2, 35),
  ('2025-01-08', 'AR8571', 2, 30),
  ('2025-01-25', 'AR8571', 2, 30),
  ('2025-01-08', 'AR8572', 1, 20),
  ('2025-01-15', 'BJ1145', 2, 30),
  ('2025-01-28', 'BJ1160', 1, 15),
  ('2025-01-02', 'BJ221', 1, 15),
  ('2025-01-04', 'BJ958', 1, 20),
  ('2025-01-15', 'BJ962', 2, 28),
  -- FEVEREIRO
  ('2025-02-25', '6201', 1, 5),
  ('2025-02-02', '6202', 1, 5),
  ('2025-02-02', '6203', 1, 5),
  ('2025-02-04', 'AR22', 5, 5),
  ('2025-02-15', 'AR22', 8, 15),
  ('2025-02-18', 'AR22', 1, 2),
  ('2025-02-27', 'AR22', 3, 3),
  ('2025-02-05', 'AR33', 3, 6),
  ('2025-02-07', 'AR33', 1, 3),
  ('2025-02-27', 'AR5092', 1, 2),
  ('2025-02-07', 'AR5149', 1, 3),
  ('2025-02-11', 'AR5319', 8, 24),
  ('2025-02-21', 'AR5379', 2, 20),
  ('2025-02-21', 'AR5419', 1, 3),
  ('2025-02-05', 'AR5535', 1, 15),
  ('2025-02-15', 'AR5575', 4, 20),
  ('2025-02-27', 'AR5647', 2, 30),
  ('2025-02-11', 'AR8798', 2, 14),
  ('2025-02-02', 'BJ1050', 2, 30),
  ('2025-02-04', 'BJ1050', 1, 15),
  ('2025-02-02', 'AR6059', 2, 28),
  ('2025-02-17', 'AR6066', 1, 3),
  ('2025-02-02', 'AR6199', 2, 28),
  ('2025-02-12', 'AR6430', 2, 8),
  ('2025-02-20', 'BJ994', 2, 40),
  ('2025-02-14', 'CL192', 2, 95),
  ('2025-02-14', 'FP007', 1, 33),
  ('2025-02-19', 'FP007', 1, 35),
  ('2025-02-07', 'FP007', 1, 35),
  ('2025-02-07', 'FP008', 1, 35),
  ('2025-02-13', 'FP008', 1, 35),
  ('2025-02-17', 'FP008', 1, 35),
  ('2025-02-20', 'FP008', 1, 35),
  ('2025-02-07', 'PQ136', 1, 15),
  ('2025-02-13', 'PQ136', 1, 15),
  ('2025-02-18', 'PQ178', 1, 15),
  ('2025-02-25', 'CV31', 1, 8),
  ('2025-02-25', 'CV35', 1, 9),
  ('2025-02-28', 'CV35', 1, 8),
  ('2025-02-28', 'SR24', 2, 10),
  ('2025-02-12', 'TR05513', 1, 25),
  ('2025-02-02', 'FP004', 1, 35),
  ('2025-02-21', 'FP004', 1, 30),
  -- MARÇO
  ('2025-03-08', '6203', 1, 6),
  ('2025-03-18', '30208', 1, 15),
  ('2025-03-17', 'AR22', 1, 1),
  ('2025-03-26', 'AR22', 8, 8),
  ('2025-03-26', 'AR22', 2, 2),
  ('2025-03-30', 'AR22', 2, 2),
  ('2025-03-07', 'AR33', 3, 3),
  ('2025-03-07', 'AR33', 3, 3),
  ('2025-03-14', 'AR33', 5, 5),
  ('2025-03-04', 'AR5065', 1, 25),
  ('2025-03-18', 'AR5092', 3, 3),
  ('2025-03-11', 'AR5319', 6, 18),
  ('2025-03-20', 'AR5321', 4, 12),
  ('2025-03-02', 'AR5370', 2, 20),
  ('2025-03-05', 'AR5379', 2, 20),
  ('2025-03-20', 'AR5379', 1, 25),
  ('2025-03-22', 'AR5379', 1, 25),
  ('2025-03-08', 'AR5383', 2, 20),
  ('2025-03-05', 'AR5648', 2, 6),
  ('2025-03-08', 'AR5648', 2, 6),
  ('2025-03-22', 'AR5648', 1, 4),
  ('2025-03-25', 'AR5648', 2, 6),
  ('2025-03-26', 'AR5648', 2, 8),
  ('2025-03-26', 'AR5648', 2, 8),
  ('2025-03-17', 'AR5786', 1, 3),
  ('2025-03-18', 'AR5786', 2, 6),
  ('2025-03-05', 'AR5940', 2, 8),
  ('2025-03-17', 'AR5940', 2, 6),
  ('2025-03-07', 'AR5946', 2, 12),
  ('2025-03-03', 'AR6059', 2, 12),
  ('2025-03-03', 'AR6059', 1, 2),
  ('2025-03-02', 'AR6425', 2, 20),
  ('2025-03-05', 'AR6425', 2, 20),
  ('2025-03-08', 'AR6425', 1, 5),
  ('2025-03-12', 'AR6425', 1, 10),
  ('2025-03-26', 'AR6425', 2, 20),
  ('2025-03-26', 'AR6425', 1, 10),
  ('2025-03-26', 'AR6425', 2, 20),
  ('2025-03-26', 'AR6425', 2, 20),
  ('2025-03-08', 'AR7509', 1, 10),
  ('2025-03-13', 'AR7590', 2, 18),
  ('2025-03-13', 'AR7591', 2, 30),
  ('2025-03-14', 'AR7591', 1, 15),
  ('2025-03-19', 'AR7591', 2, 28),
  ('2025-03-26', 'AR7591', 2, 28),
  ('2025-03-22', 'AR7616', 1, 25),
  ('2025-03-06', 'AR7617', 2, 12),
  ('2025-03-07', 'AR7617', 1, 25),
  ('2025-03-03', 'AR7654', 2, 10),
  ('2025-03-13', 'BJ1050', 1, 15),
  ('2025-03-26', 'BJ1062', 1, 32),
  ('2025-03-13', 'BJ1180', 1, 18),
  ('2025-03-12', 'BJ1221', 1, 15),
  ('2025-03-25', 'BJ908', 1, 15),
  ('2025-03-21', 'BJ962', 1, 28),
  ('2025-03-25', 'BJ966', 1, 14),
  ('2025-03-26', 'BJ967', 1, 18),
  ('2025-03-02', 'BJ994', 1, 20),
  ('2025-03-11', 'CV35', 1, 8),
  ('2025-03-21', 'CV35', 2, 20),
  ('2025-03-17', 'CV409', 1, 10),
  ('2025-03-03', 'FP004', 1, 30),
  ('2025-03-11', 'FP004', 1, 33),
  ('2025-03-26', 'FP004', 1, 32),
  ('2025-03-06', 'FP007', 1, 33),
  ('2025-03-08', 'FP007', 1, 30),
  ('2025-03-26', 'FP007', 1, 34),
  ('2025-03-02', 'FP008', 1, 35),
  ('2025-03-20', 'FP008', 1, 35),
  ('2025-03-20', 'FP008', 1, 35),
  ('2025-03-21', 'FP008', 1, 34),
  ('2025-03-17', 'FP027', 1, 34),
  ('2025-03-17', 'IA5579B', 1, 35),
  ('2025-03-03', 'PQ136', 1, 15),
  ('2025-03-03', 'PQ346', 1, 15),
  ('2025-03-05', 'RB9671', 1, 25),
  ('2025-03-19', 'SR108', 1, 6),
  ('2025-03-29', 'TR05412', 4, 60),
  ('2025-03-20', 'TR05960', 2, 28),
  ('2025-03-13', 'TR5959', 1, 20),
  ('2025-03-13', 'TR6014', 2, 30),
  ('2025-03-13', 'TR6014', 1, 25),
  ('2025-03-25', 'TR5984', 1, 30),
  -- ABRIL
  ('2025-04-05', '6202', 1, 5),
  ('2025-04-11', '30208', 1, 15),
  ('2025-04-26', 'AR5025', 2, 20),
  ('2025-04-04', 'AR5048', 2, 8),
  ('2025-04-02', 'AR5149', 2, 6),
  ('2025-04-05', 'AR5149', 1, 9),
  ('2025-04-11', 'AR5149', 1, 3),
  ('2025-04-08', 'AR5194', 1, 3),
  ('2025-04-17', 'AR5370', 2, 20),
  ('2025-04-04', 'AR6425', 1, 10),
  ('2025-04-15', 'AR5648', 2, 8),
  ('2025-04-03', 'AR5648', 2, 8),
  ('2025-04-17', 'AR5647', 4, 40),
  ('2025-04-18', 'AR5647', 2, 20),
  ('2025-04-21', 'AR5647', 1, 10),
  ('2025-04-03', 'AR7509', 2, 24),
  ('2025-04-02', 'AR7591', 2, 28),
  ('2025-04-11', 'AR7578', 2, 24),
  ('2025-04-04', 'AR7617', 1, 25),
  ('2025-04-14', 'AR8570', 2, 30),
  ('2025-04-14', 'AR8572', 2, 40),
  ('2025-04-11', 'AR8799', 2, 30),
  ('2025-04-05', 'BJ1130', 2, 24),
  ('2025-04-08', 'BJ1130', 1, 28),
  ('2025-04-16', 'BJ1130', 1, 12),
  ('2025-04-11', 'BJ1180', 2, 30),
  ('2025-04-14', 'BJ1180', 2, 36),
  ('2025-04-17', 'BJ1180', 1, 17),
  ('2024-04-09', 'BJ956', 1, 18),
  ('2024-04-09', 'BJ962', 2, 28),
  ('2025-04-16', 'CM159-5400', 1, 35),
  ('2025-04-11', 'CMK149-5300', 1, 35),
  ('2025-04-04', 'CMK159-500', 1, 30),
  ('2025-04-21', 'CSK206-0978', 1, 5),
  ('2025-04-18', 'CV', 1, 30),
  ('2025-04-02', 'CV33', 1, 8),
  ('2025-04-11', 'CV33', 1, 10),
  ('2025-04-03', 'CV35', 1, 10),
  ('2025-04-03', 'CV68', 1, 8),
  ('2025-04-05', 'FP004', 1, 30),
  ('2025-04-08', 'FP004', 1, 35),
  ('2025-04-15', 'IA5542', 1, 35),
  ('2025-04-12', 'PQ178', 2, 40),
  ('2024-04-09', 'PQ234', 1, 15),
  ('2025-04-16', 'PQ598', 2, 38),
  ('2025-04-08', 'RB6971', 1, 25),
  ('2024-04-09', 'RB9589', 1, 20),
  ('2025-04-14', 'SR108', 1, 5),
  ('2024-04-09', 'TR05467', 1, 14),
  ('2024-04-09', 'TR05470', 2, 28),
  ('2025-04-18', 'TR05806', 1, 20),
  ('2025-04-08', 'TR05959', 1, 25),
  -- MAIO
  ('2025-05-19', 'AR22', 8, 8),
  ('2025-05-20', 'AR22', 8, 8),
  ('2025-05-23', 'AR22', 4, 8),
  ('2025-05-28', 'AR22', 2, 2),
  ('2025-05-02', 'AR32', 4, 8),
  ('2025-05-20', 'AR33', 2, 4),
  ('2025-05-10', 'AR5065', 1, 25),
  ('2025-05-17', 'AR5092', 8, 16),
  ('2025-05-20', 'AR5092', 1, 8),
  ('2025-05-09', 'AR5149', 3, 9),
  ('2025-05-25', 'AR5149', 1, 3),
  ('2025-05-14', 'AR5394', 1, 25),
  ('2025-05-19', 'AR5543', 1, 25),
  ('2025-05-05', 'AR5648', 1, 4),
  ('2025-05-19', 'AR5648', 2, 8),
  ('2025-05-23', 'AR5786', 1, 5),
  ('2025-05-02', 'AR5946', 1, 24),
  ('2025-05-08', 'AR5946', 1, 24),
  ('2025-05-08', 'AR5946', 2, 20),
  ('2025-05-02', 'AR6060', 1, 6),
  ('2025-05-17', 'AR6060', 2, 6),
  ('2025-05-16', 'AR6190', 2, 16),
  ('2025-05-05', 'AR6195', 2, 30),
  ('2025-05-10', 'AR6425', 2, 20),
  ('2025-05-16', 'AR6425', 4, 40),
  ('2025-05-25', 'AR6586', 2, 6),
  ('2025-05-19', 'AR7527', 4, 48),
  ('2025-05-23', 'AR7527', 4, 48),
  ('2025-05-20', 'AR7571', 1, 8),
  ('2025-05-20', 'AR7578', 2, 24),
  ('2025-05-28', 'AR7578', 1, 12),
  ('2025-05-14', 'AR7590', 1, 16),
  ('2025-05-14', 'AR7590', 1, 9),
  ('2025-05-16', 'AR7591', 1, 14),
  ('2025-05-22', 'AR7591', 2, 30),
  ('2025-05-27', 'AR7591', 2, 30),
  ('2025-05-02', 'AR7625', 4, 60),
  ('2025-05-06', 'AR7625', 2, 60),
  ('2025-05-02', 'AR7626', 4, 76),
  ('2025-05-06', 'AR7626', 2, 75),
  ('2025-05-05', 'AR7654', 2, 14),
  ('2025-05-16', 'AR7654', 2, 14),
  ('2025-05-11', 'AR8367', 1, 47),
  ('2025-05-31', 'AR8367', 1, 24),
  ('2025-05-23', 'AR8381', 1, 24),
  ('2025-05-28', 'AR8381', 2, 20),
  ('2025-05-20', 'AR8418', 2, 16),
  ('2025-05-23', 'AR8571', 2, 30),
  ('2025-05-02', 'AR8572', 2, 40),
  ('2025-05-11', 'BJ1050', 2, 30),
  ('2025-05-10', 'BJ1130', 2, 28),
  ('2025-05-09', 'BJ1145', 1, 15),
  ('2025-05-02', 'BJ1202', 1, 15),
  ('2025-05-06', 'BJ1202', 2, 30),
  ('2025-05-02', 'BJ1203', 1, 45),
  ('2025-05-06', 'BJ1203', 2, 80),
  ('2025-05-09', 'CM159-5400', 1, 35),
  ('2025-05-05', 'CV33', 1, 10),
  ('2025-05-23', 'CV33', 2, 16),
  ('2025-05-31', 'CV33', 1, 8),
  ('2025-05-24', 'FP004', 1, 35),
  ('2025-05-07', 'FP007', 1, 35),
  ('2025-05-31', 'FP008', 1, 35),
  ('2025-05-14', 'FP027', 1, 32),
  ('2025-05-09', 'IA5542', 1, 35),
  ('2025-05-19', 'IA5587', 1, 35),
  ('2025-05-23', 'IA5587', 1, 35),
  ('2025-05-10', 'PQ171', 2, 9),
  ('2025-05-05', 'PQ176', 1, 20),
  ('2025-05-17', 'PQ178', 1, 18),
  ('2025-05-10', 'PQ234', 1, 15),
  ('2025-05-11', 'PQ234', 1, 15),
  ('2025-05-19', 'PQ346', 1, 15),
  ('2025-05-05', 'PQ589', 1, 20),
  ('2025-05-16', 'PQ958', 1, 20),
  ('2025-05-10', 'RB9603', 1, 20),
  ('2025-05-02', 'TR05414', 2, 40),
  ('2025-05-02', 'TR05415', 1, 35),
  -- JUNHO
  ('2025-06-19', 'AR22', 1, 1),
  ('2025-06-25', 'AR5065', 1, 25), -- Wait, user has 10-Jun-25, 13-Jun-25
  ('2025-06-10', 'AR5065', 2, 20),
  ('2025-06-13', 'AR5065', 2, 20),
  ('2025-06-05', 'AR5149', 1, 3),
  ('2025-06-05', 'AR5149', 2, 6),
  ('2025-06-12', 'AR5149', 1, 10),
  ('2025-06-13', 'AR5149', 1, 3),
  ('2025-06-18', 'AR5149', 1, 3),
  ('2025-06-19', 'AR5149', 2, 6),
  ('2025-06-21', 'AR5394', 2, 23),
  ('2025-06-26', 'AR5394', 2, 20),
  ('2025-06-05', 'AR5413', 1, 15),
  ('2025-06-04', 'AR5535', 1, 15),
  ('2025-06-11', 'AR5535', 1, 15),
  ('2025-06-18', 'AR5543', 1, 25),
  ('2025-06-08', 'AR5543', 1, 25),
  ('2025-06-05', 'AR5543A', 2, 20),
  ('2025-06-23', 'AR5946', 2, 24),
  ('2025-06-08', 'AR6425', 1, 40),
  ('2025-06-18', 'AR6450', 2, 20),
  ('2025-06-08', 'AR6586', 1, 5),
  ('2025-06-11', 'AR7571', 1, 7),
  ('2025-06-12', 'AR7571', 1, 4),
  ('2025-06-19', 'AR7571', 4, 1),
  ('2025-06-04', 'AR7591', 1, 13),
  ('2025-06-07', 'AR7617', 1, 24),
  ('2025-06-14', 'AR7654', 1, 10),
  ('2025-06-26', 'AR8571', 2, 30),
  ('2025-06-26', 'AR9062', 2, 60),
  ('2025-06-20', 'BJ1052', 2, 30),
  ('2025-06-04', 'BJ1160', 1, 14),
  ('2025-06-04', 'BJ1180', 2, 36),
  ('2025-06-23', 'BJ1180', 2, 35),
  ('2025-06-17', 'BJ930', 2, 30),
  ('2025-06-06', 'BJ952', 2, 26),
  ('2025-06-20', 'BJ958', 1, 18),
  ('2025-06-25', 'BJ966', 1, 14), -- Wait, user has it in March?
  ('2025-06-19', 'BJ967', 2, 40),
  ('2025-06-27', 'BJ969', 1, 18),
  ('2025-06-12', 'BJ994', 2, 40),
  ('2025-06-17', 'BJ994', 1, 20),
  ('2025-06-23', 'CS192', 2, 120),
  ('2025-06-13', 'CV18', 1, 8),
  ('2025-06-14', 'CV35', 2, 18),
  ('2025-06-21', 'CV35', 1, 10),
  ('2025-06-18', 'CV409', 1, 8),
  ('2025-06-05', 'FP004', 1, 35),
  ('2025-06-08', 'FP004', 1, 33),
  ('2025-06-13', 'FP004', 1, 33),
  ('2025-06-14', 'FP004', 1, 35),
  ('2025-06-18', 'FP007', 1, 30),
  ('2025-06-25', 'FP007', 1, 25),
  ('2025-06-26', 'FP007', 1, 35),
  ('2025-06-08', 'FP008', 1, 35),
  ('2025-06-11', 'FP008', 1, 30),
  ('2025-06-05', 'IA5590', 1, 30),
  ('2025-06-14', 'PQ176', 2, 30),
  ('2025-06-04', 'PQ598', 2, 36),
  ('2025-06-25', 'PQ758', 1, 60),
  ('2025-06-06', 'SR83', 1, 6),
  ('2025-06-06', 'TR05300', 1, 20),
  ('2025-06-19', 'TR05339', 1, 20),
  ('2025-06-23', 'TR05412', 2, 24),
  ('2025-06-17', 'TR06260', 1, 24),
  ('2025-06-13', 'TR5398', 1, 20),
  ('2025-06-10', 'TR5800', 1, 25),
  ('2025-06-12', 'TR5806', 1, 25),
  ('2025-06-12', 'TR6173', 1, 26);

  -- INSERIR NA TABELA VENDAS JOINANDO COM PEÇAS
  INSERT INTO public.vendas (
    numero_venda,
    peca_id, 
    peca_codigo, 
    peca_nome, 
    quantidade, 
    preco_unitario, 
    created_at, 
    user_id, 
    status,
    updated_at
  )
  SELECT 
    'V2025-' || LPAD(ROW_NUMBER() OVER (ORDER BY r.dt)::TEXT, 6, '0'),
    p.id, 
    p.codigo, 
    p.nome, 
    r.qty, 
    r.price, 
    r.dt::TIMESTAMP, 
    v_user_id, 
    'confirmada',
    NOW()
  FROM raw_data_import r
  JOIN public.pecas p ON p.codigo = r.code;

  DROP TABLE raw_data_import;
END $$;
